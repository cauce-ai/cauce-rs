#!/usr/bin/env bash
# =============================================================================
# Cauce-RS Pre-Commit Hook
# =============================================================================
# This hook runs before each commit to ensure code quality standards are met.
#
# Enable this hook:
#   git config core.hooksPath .githooks
#
# Bypass temporarily (not recommended):
#   git commit --no-verify
#
# Checks performed:
#   1. Code formatting (cargo fmt --check)
#   2. Linting (cargo clippy -- -D warnings)
#   3. Tests (cargo test --workspace)
# =============================================================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "========================================"
echo "Running pre-commit checks..."
echo "========================================"

# -----------------------------------------------------------------------------
# Check for required tools
# -----------------------------------------------------------------------------
check_tool() {
    local tool=$1
    local install_hint=$2

    if ! command -v "$tool" &> /dev/null; then
        echo -e "${RED}Error: $tool is not installed.${NC}"
        echo -e "${YELLOW}Install with: $install_hint${NC}"
        exit 1
    fi
}

# Verify cargo is available
check_tool "cargo" "https://rustup.rs"

# Verify rustfmt is available
if ! rustup component list | grep -q "rustfmt.*installed"; then
    echo -e "${RED}Error: rustfmt is not installed.${NC}"
    echo -e "${YELLOW}Install with: rustup component add rustfmt${NC}"
    exit 1
fi

# Verify clippy is available
if ! rustup component list | grep -q "clippy.*installed"; then
    echo -e "${RED}Error: clippy is not installed.${NC}"
    echo -e "${YELLOW}Install with: rustup component add clippy${NC}"
    exit 1
fi

# -----------------------------------------------------------------------------
# Check 1: Formatting
# -----------------------------------------------------------------------------
echo ""
echo "1/3: Checking code formatting..."

if ! cargo fmt --check 2>/dev/null; then
    echo -e "${RED}Formatting check failed!${NC}"
    echo ""
    echo "Run 'cargo fmt' to fix formatting issues, then try again."
    exit 1
fi

echo -e "${GREEN}Formatting check passed.${NC}"

# -----------------------------------------------------------------------------
# Check 2: Linting
# -----------------------------------------------------------------------------
echo ""
echo "2/3: Running clippy lints..."

if ! cargo clippy --workspace --all-targets --all-features -- -D warnings 2>/dev/null; then
    echo -e "${RED}Clippy check failed!${NC}"
    echo ""
    echo "Fix the warnings above, then try again."
    exit 1
fi

echo -e "${GREEN}Clippy check passed.${NC}"

# -----------------------------------------------------------------------------
# Check 3: Tests
# -----------------------------------------------------------------------------
echo ""
echo "3/3: Running tests..."

if ! cargo test --workspace 2>/dev/null; then
    echo -e "${RED}Tests failed!${NC}"
    echo ""
    echo "Fix the failing tests, then try again."
    exit 1
fi

echo -e "${GREEN}Tests passed.${NC}"

# -----------------------------------------------------------------------------
# Success
# -----------------------------------------------------------------------------
echo ""
echo "========================================"
echo -e "${GREEN}All pre-commit checks passed!${NC}"
echo "========================================"

exit 0
