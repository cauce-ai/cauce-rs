# =============================================================================
# Cauce-RS Release Workflow
# =============================================================================
# This workflow builds and publishes release binaries when a version tag is pushed.
#
# Trigger: Push tags matching v*.*.* (e.g., v1.0.0, v2.1.3)
#
# Targets (6 platforms):
#   - x86_64-unknown-linux-gnu: Standard Linux (glibc)
#   - x86_64-unknown-linux-musl: Static Linux (Alpine-compatible)
#   - aarch64-unknown-linux-gnu: ARM64 Linux
#   - x86_64-apple-darwin: Intel Mac
#   - aarch64-apple-darwin: Apple Silicon Mac
#   - x86_64-pc-windows-msvc: Windows
#
# For more information, see: specs/002-ci-cd-pipeline/quickstart.md
# =============================================================================

name: Release

on:
  push:
    tags:
      - "v*.*.*"

env:
  CARGO_TERM_COLOR: always

jobs:
  # ---------------------------------------------------------------------------
  # Build Release Binaries
  # ---------------------------------------------------------------------------
  # Builds optimized release binaries for all supported platforms.
  build:
    name: Build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64 (glibc)
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            cross: false

          # Linux x86_64 (musl - static)
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            cross: true

          # Linux ARM64
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            cross: true

          # macOS Intel
          - target: x86_64-apple-darwin
            os: macos-latest
            cross: false

          # macOS Apple Silicon
          - target: aarch64-apple-darwin
            os: macos-latest
            cross: false

          # Windows
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            cross: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools
        if: matrix.cross
        uses: taiki-e/install-action@cross

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}

      - name: Build release binary (native)
        if: "!matrix.cross"
        run: cargo build --release --target ${{ matrix.target }}

      - name: Build release binary (cross)
        if: matrix.cross
        run: cross build --release --target ${{ matrix.target }}

      - name: Package binary (Unix)
        if: runner.os != 'Windows'
        run: |
          cd target/${{ matrix.target }}/release
          # Find all binaries (excluding .d files and libraries)
          for bin in $(find . -maxdepth 1 -type f -perm -u+x ! -name "*.d" ! -name "*.so" ! -name "*.dylib" 2>/dev/null || true); do
            if [ -f "$bin" ]; then
              tar -czvf "../../../${bin##*/}-${{ matrix.target }}.tar.gz" "$bin"
            fi
          done
          cd ../../..

      - name: Package binary (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $binaries = Get-ChildItem -Path "target/${{ matrix.target }}/release/*.exe" -File
          foreach ($bin in $binaries) {
            $name = $bin.BaseName
            Compress-Archive -Path $bin.FullName -DestinationPath "$name-${{ matrix.target }}.zip"
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.target }}
          path: |
            *.tar.gz
            *.zip
          if-no-files-found: warn

  # ---------------------------------------------------------------------------
  # Create GitHub Release
  # ---------------------------------------------------------------------------
  # Creates a GitHub release and uploads all binaries.
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build]
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: binaries-*
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/ || echo "No artifacts directory"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
